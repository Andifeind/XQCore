/*!
 * XQCore - 0.5.1
 * 
 * Model View Presenter Javascript Framework
 *
 * XQCore is licenced under MIT Licence
 * http://opensource.org/licenses/MIT
 *
 * Copyright (c) 2012 - 2013 Noname Media, http://noname-media.com
 * Author Andi Heinkelein
 *
 * Creation Date: 2013-12-06
 */
var XQCore;!function(a,b){"use strict";"function"==typeof define&&define.amd?define("xqcore",["jquery","handlebars"],b):"undefined"!=typeof module&&module.exports?module.exports=b(require("jquery"),require("handlebars")):a.XQCore=b(a.jQuery,a.Handlebars)}(this,function(a,b){"use strict";return XQCore={version:"0.5.1",defaultRoute:"default",html5Routes:!1,hashBang:"#!",callerEvent:"callerEvent"},XQCore.extend=a.extend,XQCore.isEmptyObject=a.isEmptyObject,XQCore._dump={},XQCore.dump=function(a){return XQCore._dump[a]?(console.log("[XQCore dump]",a,XQCore._dump[a]),XQCore._dump[a]):!1},XQCore.require=function(c){return"jquery"===c?a:"handlebars"===c?b:void 0},XQCore}),XQCore.Event=function(){"use strict";/*!
	 * EventEmitter v4.2.5 - git.io/ee
	 * Oliver Caldwell
	 * MIT license
	 * @preserve
	 */
function a(){}function b(a,b){for(var c=a.length;c--;)if(a[c].listener===b)return c;return-1}function c(a){return function(){return this[a].apply(this,arguments)}}var d=a.prototype;return d.getListeners=function(a){var b,c,d=this._getEvents();if("object"==typeof a){b={};for(c in d)d.hasOwnProperty(c)&&a.test(c)&&(b[c]=d[c])}else b=d[a]||(d[a]=[]);return b},d.flattenListeners=function(a){var b,c=[];for(b=0;b<a.length;b+=1)c.push(a[b].listener);return c},d.getListenersAsObject=function(a){var b,c=this.getListeners(a);return c instanceof Array&&(b={},b[a]=c),b||c},d.addListener=function(a,c){var d,e=this.getListenersAsObject(a),f="object"==typeof c;for(d in e)e.hasOwnProperty(d)&&-1===b(e[d],c)&&e[d].push(f?c:{listener:c,once:!1});return this},d.on=c("addListener"),d.addOnceListener=function(a,b){return this.addListener(a,{listener:b,once:!0})},d.once=c("addOnceListener"),d.defineEvent=function(a){return this.getListeners(a),this},d.defineEvents=function(a){for(var b=0;b<a.length;b+=1)this.defineEvent(a[b]);return this},d.removeListener=function(a,c){var d,e,f=this.getListenersAsObject(a);for(e in f)f.hasOwnProperty(e)&&(d=b(f[e],c),-1!==d&&f[e].splice(d,1));return this},d.off=c("removeListener"),d.addListeners=function(a,b){return this.manipulateListeners(!1,a,b)},d.removeListeners=function(a,b){return this.manipulateListeners(!0,a,b)},d.manipulateListeners=function(a,b,c){var d,e,f=a?this.removeListener:this.addListener,g=a?this.removeListeners:this.addListeners;if("object"!=typeof b||b instanceof RegExp)for(d=c.length;d--;)f.call(this,b,c[d]);else for(d in b)b.hasOwnProperty(d)&&(e=b[d])&&("function"==typeof e?f.call(this,d,e):g.call(this,d,e));return this},d.removeEvent=function(a){var b,c=typeof a,d=this._getEvents();if("string"===c)delete d[a];else if("object"===c)for(b in d)d.hasOwnProperty(b)&&a.test(b)&&delete d[b];else delete this._events;return this},d.removeAllListeners=c("removeEvent"),d.emitEvent=function(a,b){var c,d,e,f,g=this.getListenersAsObject(a);for(e in g)if(g.hasOwnProperty(e))for(d=g[e].length;d--;)c=g[e][d],c.once===!0&&this.removeListener(a,c.listener),f=c.listener.apply(this,b||[]),f===this._getOnceReturnValue()&&this.removeListener(a,c.listener);return this},d.trigger=c("emitEvent"),d.emit=function(a){var b=Array.prototype.slice.call(arguments,1);return this.emitEvent(a,b)},d.setOnceReturnValue=function(a){return this._onceReturnValue=a,this},d._getOnceReturnValue=function(){return this.hasOwnProperty("_onceReturnValue")?this._onceReturnValue:!0},d._getEvents=function(){return this._events||(this._events={})},a}(),XQCore.Logger=function(){"use strict";function a(a){return 1e3>a?a+" ms":6e4>a?Math.round(a/100)/10+" sec":Math.round(a/6e4)+" min "+Math.round(a%6e4/1e3)+" sec"}var b=function(){};return b.prototype.log=function(){var a;this.debug&&(a=Array.prototype.slice.call(arguments),a.unshift("["+this.name+"]"),console.log.apply(console,a))},b.prototype.warn=function(){var a;this.debug&&(a=Array.prototype.slice.call(arguments),a.unshift("["+this.name+"]"),console.warn.apply(console,a))},b.prototype.error=function(){var a;this.debug&&(a=Array.prototype.slice.call(arguments),a.unshift("["+this.name+"]"),console.error.apply(console,a))},b.prototype.timer=function(b){var c={start:null,stop:null,name:b,logger:this,end:function(){this.stop=Date.now(),this.logger.log("Timer "+this.name+" runs: ",a(this.stop-this.start))}};return this.log("Start Timer",b),c.start=Date.now(),c},b.prototype.__scope={getHumanTime:a},b}(),function(a,b){"use strict";var c,d=function(a,b){return a&&(a=a.split("."),a.forEach(function(a){b=b[a]})),b};c=function(c){c===b&&(c={}),this.__state="starting",this.customInit=c.init,delete c.init,this.customValidate=c.validate,delete c.validate,this.conf=c,a.extend(this,c,new a.Logger),a.extend(this,new a.Event),this.name=(c.name||"Nameless")+"Model",this.debug=Boolean(c.debug),this._isValid=!1,this.properties={},this.schema=c.schema,this.defaults&&!a.isEmptyObject(this.defaults)&&this.set(this.defaults)},a.Sync&&a.extend(c.prototype,a.Sync.prototype),c.prototype.init=function(){this.debug&&(a._dump[this.name]=this),"function"==typeof this.customInit&&this.customInit.call(this),this.state("ready")},c.prototype.state=function(a){this.__state=a,this.emit("state."+a)},c.prototype.getState=function(){return this.__state},c.prototype.set=function(){var a,b,c={},d=this.get();if(null===arguments[0])c=arguments[1],this.log("Set data",c,d);else if("object"==typeof arguments[0])c=arguments[0],this.log("Set data",c,d);else if("string"==typeof arguments[0]){c=this.get(),b=arguments[0];var e=arguments[1];c[b]=e,this.log("Set data",c,d)}else this.warn("Data are incorrect in model.set()",arguments);return this.schema&&(a=this.validate(c),null!==a)?(this.warn("Validate error in model.set",a),this.emit("validation.error",a),!1):this.customValidate&&(a=this.customValidate(c),null!==a)?(this.warn("Validate error in model.set",a),this.emit("validation.error",a),!1):(this.properties=c,this.emit("data.change",c,d),b&&this.emit("change."+b,c[b]),!0)},c.prototype.get=function(a){return a===b?this.properties:this.properties[a]},c.prototype.has=function(a){return!!this.properties[a]},c.prototype.reset=function(){this.log("Reset model"),this.properties={},this.removeAllListener()},c.prototype.append=function(a,b){1===arguments.length&&(b=a,a=null);var c=this.properties,d=this.get(),e=!0;return a&&a.split(".").forEach(function(a){c=c[a]}),c instanceof Array?c.push(b):null===a?(this.properties=[b],c=this.get()):this.warn("Model.append requires an array. Dataset isn't an array",a),e&&this.emit("data.change",c,d),b},c.prototype.prepend=function(a,b){1===arguments.length&&(b=a,a=null);var c=this.properties,d=this.get(),e=!0;return a&&a.split(".").forEach(function(a){c=c[a]}),c instanceof Array?c.unshift(b):null===a?(this.properties=[b],c=this.get()):this.warn("Model.append requires an array. Dataset isn't an array",a),e&&this.emit("data.change",c,d),b},c.prototype.remove=function(a,b){var c=this.properties,d=null;return a.split(".").forEach(function(a){c=c[a]}),c instanceof Array?(d=c.splice(b,1),d=d[0]||null):this.warn("Model.remove() doesn't work with Objects in model",this.name),d},c.prototype.search=function(a,b){var c=d(a,this.properties);if(c)for(var e=0;e<c.length;e++){var f,g=c[e];for(var h in b)if(b.hasOwnProperty(h)){if(!g[h]||g[h]!==b[h]){f=!1;break}f=!0}if(f===!0)return g}return null},c.prototype.sortBy=function(a,b){1===arguments.length&&(b=a,a=null);var c,e=d(a,this.properties);return e.sort(function(a,e){c=-1;for(var f in b)if(b.hasOwnProperty(f)){if(c=String(d(f,a)).localeCompare(String(d(f,e))),0===c)continue;-1===b[f]&&(c=c>0?-1:1);break}return c}),this.set(a,e),e},c.prototype.validate=function(b,c){var d=[];return c=c||this.schema,c&&Object.keys(c).forEach(function(e){if("object"==typeof b[e]&&"undefined"==typeof c[e].type){var f=this.validate(a.extend({},b[e]),a.extend({},c[e]));return Array.isArray(f)&&f.length>0&&(d=d.concat(f)),void 0}var g=this.validateOne(c[e],b[e]);g.isValid===!0?b[e]=g.value:(g.error.property=e,d.push(g.error))}.bind(this)),0===d.length?(this._isValid=!0,null):(this._isValid=!1,d)},c.prototype.validateOne=function(a,c){var d=null,e="function"==typeof a.type?typeof a.type():a.type.toLowerCase();if(""===c&&a.noEmpty===!0&&(c=b),c!==b&&null!==c||!a.default||(c=a.default),c===b||null===c||""===c)a.required===!0&&(d={msg:"Property is undefined or null, but it's required",errCode:10});else if("string"===e)a.convert&&"number"==typeof c&&(c=String(c)),e!==typeof c?d={msg:"Property type is a "+typeof c+", but a string is required",errCode:11}:a.min&&a.min>c.length?d={msg:"String length is too short",errCode:12}:a.max&&a.max<c.length?d={msg:"String length is too long",errCode:13}:a.match&&!a.match.test(c)&&(d={msg:"String doesn't match regexp",errCode:14});else if("number"===e)a.convert&&"string"==typeof c&&(c=parseInt(c,10)),e!==typeof c?d={msg:"Property type is a "+typeof c+", but a number is required",errCode:21}:a.min&&a.min>c?d={msg:"Number is too low",errCode:22}:a.max&&a.max<c&&(d={msg:"Number is too high",errCode:23});else if("date"===e){if(c){var f=Date.parse(c);isNaN(f)&&(d={msg:"Property isn't a valid date",errCode:31})}}else"array"===e?Array.isArray(c)?a.min&&a.min>c.length?d={msg:"Array length is "+c.length+" but must be greater than "+a.min,errCode:42}:a.max&&a.max<c.length&&(d={msg:"Array length is "+c.length+" but must be lesser than "+a.max,errCode:43}):d={msg:"Property type is a "+typeof c+", but an array is required",errCode:41}:"object"===e?"object"!=typeof c&&(d={msg:"Property isn't a valid object",errCode:51}):"objectid"===e?/^[a-zA-Z0-9]{24}$/.test(c)||(d={msg:"Property isn't a valid objectId",errCode:52}):"boolean"===e&&"boolean"!=typeof c&&(d={msg:"Property isn't a valid boolean",errCode:61});return null===d?d={isValid:!0,value:c,error:null}:(this.warn("Validation error on property",d,"Data:",c),d={isValid:!1,value:c,error:d}),d},c.prototype.isValid=function(){return this._isValid},a.Model=c}(this.XQCore);